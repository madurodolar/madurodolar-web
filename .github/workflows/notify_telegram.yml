# .github/workflows/notify_telegram.yml

name: üí¨ Notify Telegram with Rates

on:
  # 1) Regenerate prices every minute (this keeps price.json fresh on gh-pages)
  schedule:
    - cron: '*/1 * * * *'
  # 2) Notify Telegram only at 9 AM EST (14 UTC) and 4 PM EST (21 UTC)
    - cron: '0 14 * * *'
    - cron: '0 21 * * *'
  # 3) Allow manual trigger
  workflow_dispatch:

jobs:
  build-and-notify:
    runs-on: ubuntu-latest
    steps:

      # --- ALWAYS regenerate your price.json from Binance ---
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install dependencies (jq & curl)
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: Fetch Binance P2P & update price.json
        run: |
          chmod +x scripts/fetch_binance_p2p.sh
          ./scripts/fetch_binance_p2p.sh

      - name: Commit & push price.json if changed
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add price.json || true
          git diff --quiet --exit-code || (git commit -m "chore: update price.json @ $(date -u +'%Y-%m-%dT%H:%M:%SZ')" && git push)

      # --- ONLY on the Telegram‚Äêschedule or manual dispatch: send message ---
      - name: Send Telegram message
        if: |
          github.event_name == 'workflow_dispatch' ||
          (github.event_name == 'schedule' &&
           (github.event.schedule == '0 14 * * *' || github.event.schedule == '0 21 * * *'))
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # 1) Read Binance P2P prices
          data=$(cat price.json)
          sell=$(jq -r '.sell' <<<"$data")
          buy=$(jq -r '.buy'  <<<"$data")

          # 2) Read BCV rate from bcv.json
          bcv=$(jq -r '.rate'  bcv.json)
          bcvu=$(jq -r '.updated' bcv.json)

          # 3) Build the message
          today=$(date +"%Y-%m-%d")
          text="üí° *Referencia informativa: Valor del d√≥lar hoy en Venezuela*"
          text+="\n\nüìä *Mercado Binance P2P* (informativo):"
          text+="\n‚Ä¢ Compra: *${buy}* VES"
          text+="\n‚Ä¢ Venta:  *${sell}* VES"
          text+="\n\nüèõ *Oficial (BCV):* ${bcv} VES"
          text+="\n_Ultima actualizaci√≥n BCV:_ \`${bcvu}\`"
          text+="\n\nüìÖ _${today}_"

          # 4) Send to Telegram
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
               -d chat_id="${TELEGRAM_CHAT_ID}" \
               -d parse_mode=MarkdownV2 \
               -d disable_web_page_preview=true \
               -d text="${text}"

